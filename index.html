<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BGP Policy City | Warp Core Edition</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&family=Orbitron:wght@500;700;900&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #00f0ff; /* Electric Cyan */
            --secondary: #7000ff; /* Warp Purple */
            --accent: #ff003c; /* Alert Red */
            --bg-deep: #020205;
            --glass-border: rgba(0, 240, 255, 0.2);
            --hud-bg: rgba(5, 5, 10, 0.85);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-deep);
            color: #e2e8f0;
            overflow: hidden;
        }
        
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .font-cyber { font-family: 'Orbitron', sans-serif; }
        .font-tech { font-family: 'Rajdhani', sans-serif; }
        
        /* --- CUSTOM SCROLLBAR --- */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.5); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--secondary); border-radius: 2px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* --- HUD & SHAPES --- */
        .hud-panel-left {
            background: var(--hud-bg);
            clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px);
            border-left: 2px solid var(--primary);
            border-top: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.1);
        }
        .hud-panel-right {
            background: var(--hud-bg);
            clip-path: polygon(0 0, calc(100% - 10px) 0, 100% 10px, 100% 100%, 0 100%);
            border-right: 2px solid var(--primary);
            border-top: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.1);
        }

        /* Glass panel upgrade */
        .glass-panel {
            background: rgba(10, 10, 20, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5), 0 0 15px rgba(0, 240, 255, 0.05);
            position: relative;
        }
        
        /* Corner accents for panels */
        .glass-panel::before {
            content: ''; position: absolute; top: -1px; left: -1px; width: 10px; height: 10px;
            border-top: 2px solid var(--primary); border-left: 2px solid var(--primary);
            pointer-events: none;
        }
        .glass-panel::after {
            content: ''; position: absolute; bottom: -1px; right: -1px; width: 10px; height: 10px;
            border-bottom: 2px solid var(--primary); border-right: 2px solid var(--primary);
            pointer-events: none;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
        }

        /* --- GLITCH EFFECT --- */
        .glitch-text { position: relative; color: white; text-shadow: 2px 0 var(--secondary); }
        .glitch-text::before, .glitch-text::after {
            content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-deep);
        }
        .glitch-text::before {
            left: 2px; text-shadow: -1px 0 #ff00c1; clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim 5s infinite linear alternate-reverse;
        }
        .glitch-text::after {
            left: -2px; text-shadow: -1px 0 #00fff9; clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim2 5s infinite linear alternate-reverse;
        }
        @keyframes glitch-anim {
            0% { clip: rect(12px, 9999px, 86px, 0); } 5% { clip: rect(34px, 9999px, 12px, 0); }
            10% { clip: rect(6px, 9999px, 55px, 0); } 100% { clip: rect(12px, 9999px, 86px, 0); }
        }
        @keyframes glitch-anim2 {
            0% { clip: rect(82px, 9999px, 12px, 0); } 5% { clip: rect(12px, 9999px, 3px, 0); }
            10% { clip: rect(55px, 9999px, 76px, 0); } 100% { clip: rect(82px, 9999px, 12px, 0); }
        }

        /* --- SCANLINE & CRT EFFECTS --- */
        .crt-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.6) 100%);
            pointer-events: none; z-index: 50;
        }
        .scanline {
            width: 100%; height: 2px; z-index: 51; background: rgba(0, 240, 255, 0.05);
            opacity: 0.5; position: absolute; bottom: 100%; animation: scanline 6s linear infinite;
            pointer-events: none;
        }
        @keyframes scanline { 0% { bottom: 100%; } 100% { bottom: -10px; } }

        /* --- ANIMATIONS --- */
        @keyframes dash-flow { to { stroke-dashoffset: -40; } }
        .animate-dash-slow { animation: dash-flow 1s linear infinite; }
        
        .fade-enter { opacity: 0; transform: translateY(10px); }
        .fade-enter-active { opacity: 1; transform: translateY(0); transition: opacity 300ms, transform 300ms; }
        
        .cyber-input { 
            background: rgba(0, 0, 0, 0.6); 
            border: 1px solid rgba(255,255,255,0.1); 
            transition: all 0.3s ease;
            color: #fff;
        }
        .cyber-input:focus { 
            border-color: var(--primary); 
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.3); 
            background: rgba(0, 240, 255, 0.05); 
        }

        .neon-green { text-shadow: 0 0 8px rgba(34, 197, 94, 0.8); }
        .neon-cyan { text-shadow: 0 0 10px rgba(6, 182, 212, 0.8); }
        .neon-purple { text-shadow: 0 0 10px rgba(168, 85, 247, 0.8); }
        
        .typing-cursor::after {
            content: '_'; display: inline-block; animation: blink 1s infinite;
            color: var(--primary); margin-left: 2px;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* HEADER GRID */
        .header-grid {
            background-color: #050510;
            background-image: 
                linear-gradient(rgba(0, 240, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 240, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.8);
        }

        /* TAB STYLES - Warp Style */
        .nav-tab {
            position: relative;
            transition: all 0.2s ease;
            opacity: 0.5;
            background: rgba(0,0,0,0.2);
            clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%);
            margin: 0 2px;
        }
        .nav-tab:hover {
            opacity: 0.8;
            background: rgba(0, 240, 255, 0.05);
            transform: translateY(-2px);
        }
        .nav-tab.active {
            opacity: 1;
            color: white;
            background: linear-gradient(135deg, rgba(0, 240, 255, 0.1), transparent);
            border-bottom: 2px solid var(--primary);
            text-shadow: 0 0 8px var(--primary);
        }
        
        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px; width: 16px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 0 10px var(--primary);
            margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px;
            background: #334155;
            border-radius: 2px;
        }

        /* --- EDUCATION ANIMATIONS --- */
        @keyframes float-particle {
            0% { transform: translate(0, 0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translate(100px, 0); opacity: 0; }
        }
        .edu-particle { animation: float-particle 2s linear infinite; }
        
        @keyframes bounce-contain {
            0% { transform: translate(0, 0); }
            25% { transform: translate(40px, 20px); }
            50% { transform: translate(20px, 40px); }
            75% { transform: translate(-10px, 20px); }
            100% { transform: translate(0, 0); }
        }
        .edu-contained { animation: bounce-contain 4s ease-in-out infinite; }
        
        @keyframes slot-machine {
            0% { content: "192.168.1.10"; }
            25% { content: "192.168.1.55"; }
            50% { content: "192.168.1.102"; }
            75% { content: "192.168.1.13"; }
            100% { content: "192.168.1.10"; }
        }
        .edu-dynamic-text::after { content: "192.168.1.10"; animation: slot-machine 3s steps(4) infinite; }

        /* --- OSI STACK ANIMATION --- */
        @keyframes flow-down {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        .packet-flow-down {
            position: absolute; left: 50%; width: 8px; height: 8px; 
            background: var(--primary); border-radius: 50%;
            box-shadow: 0 0 10px var(--primary);
            transform: translateX(-50%);
            animation: flow-down 3s infinite linear;
            pointer-events: none;
            z-index: 20;
        }
        
        .osi-layer {
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        .osi-layer:hover {
            background: rgba(0, 240, 255, 0.1);
            border-left: 4px solid var(--primary);
            padding-left: 1rem;
        }
        .osi-layer.active {
            background: linear-gradient(90deg, rgba(0, 240, 255, 0.2), transparent);
            border-left: 4px solid var(--primary);
            border-right: 4px solid var(--secondary);
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.1);
        }
        
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen w-screen text-slate-100 overflow-hidden">

    <!-- CRT Visual Effects -->
    <div class="crt-overlay"></div>
    <div class="scanline"></div>

    <!-- KNOWLEDGE MODAL (General) -->
    <div id="knowledge-modal" class="modal-overlay fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-2xl p-6 relative overflow-hidden bg-black">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i data-lucide="x"></i></button>
            <div class="absolute -right-10 -top-10 text-9xl text-cyan-500/5 font-cyber pointer-events-none">DATA</div>
            <h2 id="modal-title" class="text-2xl font-bold font-cyber text-cyan-400 mb-2 neon-cyan">Term Decrypted</h2>
            <div class="h-0.5 w-full bg-gradient-to-r from-cyan-500 to-transparent mb-4"></div>
            <div id="modal-content" class="text-slate-300 font-mono text-sm leading-relaxed space-y-4"></div>
            <div class="mt-6 pt-4 border-t border-slate-800 flex justify-between items-center">
                <div class="text-[10px] text-slate-500 font-mono">SOURCE: WARP_DRIVE_DB_V2.0</div>
                <button onclick="closeModal()" class="px-6 py-2 bg-cyan-900/30 hover:bg-cyan-800/50 text-cyan-300 border border-cyan-500/50 rounded-sm text-xs font-bold tracking-widest uppercase transition-all hover:shadow-[0_0_15px_rgba(6,182,212,0.4)]">Close Terminal</button>
            </div>
        </div>
    </div>

    <!-- OSI MASTER CLASS MODAL (Full Screen) -->
    <div id="osi-modal" class="modal-overlay fixed inset-0 z-[110] hidden flex items-center justify-center p-4 md:p-10">
        <div class="glass-panel w-full h-full max-w-6xl flex flex-col relative overflow-hidden bg-[#050510]">
            <!-- Modal Background -->
            <div class="absolute inset-0 z-0">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-500 via-purple-500 to-cyan-500"></div>
                <div class="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-purple-500 via-cyan-500 to-purple-500"></div>
                <div class="absolute inset-0 opacity-10 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIj48ZyBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9IkQwIDQwaDQwVjBIMHY0MHptMS0xaDM4VjFIMXYzOHoiIGZpbGw9IiMwMGYwZmYiIGZpbGwtb3BhY2l0eT0iMC4xIi8+PC9nPjwvc3ZnPg==')]"></div>
            </div>

            <!-- Header -->
            <div class="relative z-10 flex justify-between items-center p-6 border-b border-slate-800 bg-black/40 backdrop-blur">
                <div class="flex items-center gap-4">
                    <div class="p-3 bg-cyan-900/20 border border-cyan-500/50 rounded">
                        <i data-lucide="layers" class="text-cyan-400 w-8 h-8"></i>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold font-cyber text-white tracking-widest neon-cyan">OSI MASTER CLASS</h2>
                        <div class="text-xs font-mono text-purple-400 tracking-[0.3em]">OPEN SYSTEMS INTERCONNECTION MODEL</div>
                    </div>
                </div>
                <button onclick="closeOsiModal()" class="text-slate-400 hover:text-white hover:rotate-90 transition-transform duration-300">
                    <i data-lucide="x" class="w-8 h-8"></i>
                </button>
            </div>

            <!-- Content Grid -->
            <div class="relative z-10 flex-1 overflow-y-auto custom-scrollbar p-8">
                <div id="osi-detail-content" class="grid grid-cols-1 md:grid-cols-2 gap-8 h-full">
                    <!-- Injected via JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- PROTOCOL DEEP DIVE MODAL (Full Screen) -->
    <div id="protocol-modal" class="modal-overlay fixed inset-0 z-[110] hidden flex items-center justify-center p-4 md:p-10">
        <div class="glass-panel w-full h-full max-w-5xl flex flex-col relative overflow-hidden bg-[#050510]">
            <!-- Modal Background -->
            <div class="absolute inset-0 z-0">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-yellow-500 via-orange-500 to-yellow-500"></div>
                <div class="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-orange-500 via-yellow-500 to-orange-500"></div>
                <div class="absolute inset-0 opacity-10 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdmlld0JveD0iMCAwIDIwIDIwIj48ZyBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9IkQwIDIwaDIwVjBIMHYyMHptMS0xaDE4VjFIMXYxOHoiIGZpbGw9IiNmM2E4MzAiIGZpbGwtb3BhY2l0eT0iMC4xIi8+PC9nPjwvc3ZnPg==')]"></div>
            </div>

            <!-- Header -->
            <div class="relative z-10 flex justify-between items-center p-6 border-b border-slate-800 bg-black/40 backdrop-blur">
                <div class="flex items-center gap-4">
                    <div class="p-3 bg-yellow-900/20 border border-yellow-500/50 rounded">
                        <i data-lucide="network" class="text-yellow-400 w-8 h-8"></i>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold font-cyber text-white tracking-widest text-yellow-400">PROTOCOL DEEP DIVE</h2>
                        <div class="text-xs font-mono text-orange-400 tracking-[0.3em]">PORTS, SERVICES & PHYSICAL LAYER</div>
                    </div>
                </div>
                <button onclick="closeProtocolModal()" class="text-slate-400 hover:text-white hover:rotate-90 transition-transform duration-300">
                    <i data-lucide="x" class="w-8 h-8"></i>
                </button>
            </div>

            <!-- Content Grid -->
            <div class="relative z-10 flex-1 overflow-y-auto custom-scrollbar p-8">
                <div id="protocol-detail-content" class="h-full">
                    <!-- Injected via JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- LEFT PANEL: VISUAL MAP (Flexible Width) -->
    <div class="relative flex-1 bg-black border-r border-slate-800 h-1/2 md:h-full overflow-hidden flex flex-col">
        <!-- Warp Starfield Canvas -->
        <canvas id="bg-canvas" class="absolute inset-0 z-0 opacity-80"></canvas>
        
        <!-- NEW HUD STATUS BAR -->
        <div class="absolute top-6 left-6 right-6 z-20 flex justify-between pointer-events-none select-none">
            <!-- Left HUD: System Status -->
            <div class="flex flex-col items-start group">
                <div class="text-[10px] text-cyan-600 font-mono tracking-[0.2em] mb-1 pl-1 opacity-70">SYSTEM_STATUS //</div>
                <div class="hud-panel-left border-red-500 pl-4 pr-6 py-2 transition-colors duration-500 flex items-center gap-3 shadow-lg" id="status-panel">
                     <div class="flex items-center justify-center w-3 h-3">
                        <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse shadow-[0_0_10px_red]" id="status-light"></div>
                     </div>
                     <div class="flex flex-col">
                         <span class="text-[10px] text-slate-500 font-bold uppercase tracking-wider leading-none">OPERATIONAL STATE</span>
                         <span class="text-sm font-bold text-red-400 font-tech tracking-widest scramble-target leading-tight mt-0.5" id="status-text">OFFLINE</span>
                     </div>
                </div>
            </div>

            <!-- Right HUD: Policy Metrics -->
            <div class="hidden md:flex flex-col items-end">
                <div class="text-[10px] text-cyan-600 font-mono tracking-[0.2em] mb-1 pr-1 opacity-70">// POLICY_METRICS</div>
                <div class="hud-panel-right pl-6 pr-4 py-2 shadow-lg flex items-center gap-4">
                     <div class="text-right">
                         <div class="text-[9px] text-slate-500 font-bold uppercase tracking-wider">ISP A PREF</div>
                         <div class="text-cyan-400 font-mono font-bold leading-none" id="pref-a-display">100</div>
                     </div>
                     <div class="h-6 w-px bg-slate-700"></div>
                     <div class="text-right">
                         <div class="text-[9px] text-slate-500 font-bold uppercase tracking-wider">ISP B PREF</div>
                         <div class="text-cyan-400 font-mono font-bold leading-none" id="pref-b-display">100</div>
                     </div>
                </div>
            </div>
        </div>

        <svg id="network-map" class="absolute inset-0 w-full h-full z-10 pointer-events-none filter drop-shadow-[0_0_8px_rgba(0,240,255,0.4)]"></svg>
        <div id="map-nodes" class="absolute inset-0 z-20 pointer-events-none"></div>
    </div>

    <!-- DRAG HANDLE (Resizable Splitter) -->
    <div id="drag-handle" class="hidden md:block w-1.5 bg-slate-800 hover:bg-cyan-500 cursor-col-resize z-40 transition-colors shadow-[0_0_10px_rgba(0,0,0,0.5)] flex items-center justify-center group relative">
        <div class="absolute inset-y-0 -left-2 -right-2 z-50 cursor-col-resize"></div> <!-- Hit area -->
        <div class="w-0.5 h-8 bg-slate-600 group-hover:bg-white rounded-full"></div>
    </div>

    <!-- RIGHT PANEL: CONTROLS (Resizable) -->
    <div id="right-panel" class="w-full md:w-[500px] bg-[#050510]/95 backdrop-blur-xl flex flex-col shadow-[0_0_50px_rgba(0,0,0,0.9)] z-30 h-1/2 md:h-full border-t md:border-t-0 md:border-l border-slate-700 min-w-[320px] max-w-[80vw]">
        
        <!-- HEADER -->
        <div class="relative shrink-0 border-b border-cyan-900/30 header-grid">
            <div class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-cyan-400 to-purple-600"></div>
            
            <div class="p-5 flex justify-between items-center relative z-10">
                <div class="flex items-center gap-4">
                    <div class="relative group cursor-help" title="System ID: NS-9000">
                        <div class="absolute inset-0 bg-cyan-400 blur opacity-20 group-hover:opacity-40 transition-opacity"></div>
                        <div class="bg-slate-900 border border-slate-700 p-2 rounded shadow-inner relative">
                            <i data-lucide="globe" class="text-cyan-400 w-6 h-6"></i>
                        </div>
                    </div>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold text-white tracking-tighter font-cyber glitch-text leading-none" id="main-header" data-text="NetSim Pro">NetSim <span class="text-cyan-400">Pro</span></h1>
                        <div class="flex items-center gap-2 mt-1">
                            <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse shadow-[0_0_5px_lime]"></div>
                            <span class="text-[10px] text-green-400 font-mono tracking-widest uppercase opacity-90">HYPERSPACE LINK: STABLE</span>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col items-end">
                    <div class="text-[9px] text-slate-500 font-bold uppercase tracking-[0.2em] mb-0.5">Efficiency Score</div>
                    <div class="text-2xl font-tech font-bold text-green-400 neon-green tabular-nums" id="score-display">0%</div>
                </div>
            </div>

            <!-- TAB NAVIGATION (SCROLLABLE) -->
            <div class="flex px-2 pb-2 overflow-x-auto custom-scrollbar gap-1">
                <button onclick="switchTab('A')" class="nav-tab flex-shrink-0 min-w-[80px] py-3 px-1 flex flex-col items-center justify-center gap-1 group" id="tab-A">
                    <span class="text-[10px] font-bold text-slate-400 group-hover:text-white tracking-wider font-tech">ISP A</span>
                    <div class="w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_8px_#22c55e]"></div>
                </button>
                <button onclick="switchTab('B')" class="nav-tab flex-shrink-0 min-w-[80px] py-3 px-1 flex flex-col items-center justify-center gap-1 group" id="tab-B">
                    <span class="text-[10px] font-bold text-slate-400 group-hover:text-white tracking-wider font-tech">ISP B</span>
                    <div class="w-1.5 h-1.5 rounded-full bg-blue-500 shadow-[0_0_8px_#3b82f6]"></div>
                </button>
                <button onclick="switchTab('eBGP')" class="nav-tab flex-shrink-0 min-w-[80px] py-3 px-1 flex flex-col items-center justify-center gap-1 group" id="tab-eBGP">
                    <span class="text-[10px] font-bold text-slate-400 group-hover:text-white tracking-wider font-tech">UPLINK</span>
                    <i data-lucide="zap" class="w-3 h-3 text-yellow-400"></i>
                </button>
                <button onclick="switchTab('zones')" class="nav-tab flex-shrink-0 min-w-[80px] py-3 px-1 flex flex-col items-center justify-center gap-1 group" id="tab-zones">
                    <span class="text-[10px] font-bold text-slate-400 group-hover:text-white tracking-wider font-tech">SECTORS</span>
                    <i data-lucide="layout-grid" class="w-3 h-3 text-cyan-400"></i>
                </button>
                <button onclick="switchTab('academy')" class="nav-tab flex-shrink-0 min-w-[80px] py-3 px-1 flex flex-col items-center justify-center gap-1 group" id="tab-academy">
                    <span class="text-[10px] font-bold text-slate-400 group-hover:text-white tracking-wider font-tech">ACADEMY</span>
                    <i data-lucide="graduation-cap" class="w-3 h-3 text-purple-400"></i>
                </button>
                <button onclick="switchTab('osi')" class="nav-tab flex-shrink-0 min-w-[80px] py-3 px-1 flex flex-col items-center justify-center gap-1 group" id="tab-osi">
                    <span class="text-[10px] font-bold text-slate-400 group-hover:text-white tracking-wider font-tech">OSI</span>
                    <i data-lucide="layers" class="w-3 h-3 text-pink-400"></i>
                </button>
                <button onclick="switchTab('protocols')" class="nav-tab flex-shrink-0 min-w-[80px] py-3 px-1 flex flex-col items-center justify-center gap-1 group" id="tab-protocols">
                    <span class="text-[10px] font-bold text-slate-400 group-hover:text-white tracking-wider font-tech">PROTOCOLS</span>
                    <i data-lucide="network" class="w-3 h-3 text-orange-400"></i>
                </button>
                <button onclick="switchTab('ports')" class="nav-tab flex-shrink-0 min-w-[80px] py-3 px-1 flex flex-col items-center justify-center gap-1 group" id="tab-ports">
                    <span class="text-[10px] font-bold text-slate-400 group-hover:text-white tracking-wider font-tech">PORTS</span>
                    <i data-lucide="list" class="w-3 h-3 text-green-400"></i>
                </button>
                <button onclick="switchTab('stp')" class="nav-tab flex-shrink-0 min-w-[80px] py-3 px-1 flex flex-col items-center justify-center gap-1 group" id="tab-stp">
                    <span class="text-[10px] font-bold text-slate-400 group-hover:text-white tracking-wider font-tech">STP</span>
                    <i data-lucide="git-branch" class="w-3 h-3 text-indigo-400"></i>
                </button>
                <button onclick="switchTab('calc')" class="nav-tab flex-shrink-0 min-w-[80px] py-3 px-1 flex flex-col items-center justify-center gap-1 group" id="tab-calc">
                    <span class="text-[10px] font-bold text-slate-400 group-hover:text-white tracking-wider font-tech">MATRIX</span>
                    <i data-lucide="binary" class="w-3 h-3 text-cyan-200"></i>
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 overflow-y-auto p-4 md:p-5 relative custom-scrollbar bg-black/20">
            <div id="advisor-container" class="mb-4 md:mb-6"></div>
            <div id="content-area"></div>
        </div>

        <!-- Terminal Log / Footer -->
        <div class="h-32 md:h-36 bg-[#020205] border-t border-slate-800 p-3 font-mono text-[11px] md:text-xs overflow-y-auto shrink-0 custom-scrollbar shadow-[inset_0_10px_20px_rgba(0,0,0,1)]" id="console-log">
            <div class="text-cyan-500 opacity-90 typing-line">warp_core > initializing logic circuits...</div>
            <div class="text-slate-500 opacity-80 typing-line">warp_core > ready for command input.</div>
            <div id="typing-anchor"></div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- RESIZABLE SPLIT PANE LOGIC ---
        const handle = document.getElementById('drag-handle');
        const rightPanel = document.getElementById('right-panel');
        let isResizing = false;

        handle.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
            handle.classList.add('bg-cyan-500');
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const newWidth = window.innerWidth - e.clientX;
            // Min 320px, Max 80% of screen
            if (newWidth > 320 && newWidth < window.innerWidth * 0.8) {
                rightPanel.style.width = `${newWidth}px`;
            }
        });

        document.addEventListener('mouseup', () => {
            isResizing = false;
            document.body.style.cursor = 'default';
            handle.classList.remove('bg-cyan-500');
            // Trigger canvas resize
            resizeCanvas();
        });

        // --- PRE-LOADED COMMON PORTS (Snippet from user CSV) ---
        const commonPorts = [
            { port: 20, protocol: "TCP", desc: "FTP Data Transfer" },
            { port: 21, protocol: "TCP", desc: "FTP Control" },
            { port: 22, protocol: "TCP/UDP", desc: "SSH (Secure Shell)" },
            { port: 23, protocol: "TCP/UDP", desc: "Telnet" },
            { port: 25, protocol: "TCP", desc: "SMTP (Email Routing)" },
            { port: 53, protocol: "TCP/UDP", desc: "DNS (Domain Name System)" },
            { port: 67, protocol: "UDP", desc: "DHCP (Server)" },
            { port: 68, protocol: "UDP", desc: "DHCP (Client)" },
            { port: 80, protocol: "TCP", desc: "HTTP (Web)" },
            { port: 110, protocol: "TCP", desc: "POP3 (Email Retrieval)" },
            { port: 123, protocol: "UDP", desc: "NTP (Network Time)" },
            { port: 143, protocol: "TCP", desc: "IMAP (Email Management)" },
            { port: 443, protocol: "TCP", desc: "HTTPS (Secure Web)" },
            { port: 3389, protocol: "TCP/UDP", desc: "RDP (Remote Desktop)" }
        ];

        let loadedPorts = [...commonPorts];

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const rows = text.split('\n').slice(1); // Skip header
                loadedPorts = rows.map(row => {
                    const cols = row.split(',');
                    if (cols.length >= 3) {
                        return { port: cols[0], protocol: cols[1], desc: cols[2] };
                    }
                    return null;
                }).filter(p => p !== null);
                
                renderContent(); // Re-render table
                addLog("SYSTEM", `Loaded ${loadedPorts.length} ports from external DB.`, "success");
            };
            reader.readAsText(file);
        }

        // --- OSI GRANULAR DATA ---
        const osiLayers = [
            { 
                id: 7, 
                name: "Application", 
                pdu: "Data", 
                analogy: "The Interface / The User", 
                protocols: "HTTP, HTTPS, FTP, SMTP, DNS, SSH, Telnet", 
                devices: "PC, Phone, Web Server, Firewall (L7)", 
                summary: "The layer closest to the end user. It provides network services directly to applications (like your browser or email client).",
                deep_dive: "This is where human-computer interaction happens. When you click 'Send' on an email, Layer 7 protocols (SMTP) verify your request and begin the process. It doesn't mean the application itself (like Chrome), but the networking functions *within* the application."
            },
            { 
                id: 6, 
                name: "Presentation", 
                pdu: "Data", 
                analogy: "The Translator / The Cipher", 
                protocols: "SSL/TLS, ASCII, JPEG, MPEG, GIF", 
                devices: "Gateways, Firewalls", 
                summary: "Ensures data is usable. Handles encryption, compression, and translation.",
                deep_dive: "Think of this as the syntax layer. It converts data from the Application layer into a standard format. For example, converting a string of text into ASCII, or compressing a large file. Crucially, this is where SSL/TLS encryption happens to secure your data."
            },
            { 
                id: 5, 
                name: "Session", 
                pdu: "Data", 
                analogy: "The Conversation Manager", 
                protocols: "NetBIOS, RPC, PPTP, SMB", 
                devices: "Gateways, Load Balancers", 
                summary: "Establishes, maintains, and terminates connections (sessions) between applications.",
                deep_dive: "This layer acts like a moderator. It controls the dialogue between two computers. It decides who talks when (simplex, half-duplex, full-duplex) and ensures that if a connection is broken, it can be re-established without starting over from scratch."
            },
            { 
                id: 4, 
                name: "Transport", 
                pdu: "Segment (TCP) / Datagram (UDP)", 
                analogy: "The Shipping Box", 
                protocols: "TCP, UDP", 
                devices: "Load Balancers, Firewalls", 
                summary: "Responsible for end-to-end communication, reliability, and flow control.",
                deep_dive: "Here, large data is broken into smaller chunks called Segments. TCP (Transmission Control Protocol) ensures every chunk arrives accurately (like a registered letter). UDP (User Datagram Protocol) sends chunks fast without checking (like a live video stream). This layer also handles Ports (e.g., Port 80 for Web)."
            },
            { 
                id: 3, 
                name: "Network", 
                pdu: "Packet", 
                analogy: "The Address / The GPS", 
                protocols: "IP (IPv4/IPv6), ICMP, IPSec, OSPF, BGP", 
                devices: "Routers, Layer 3 Switches", 
                summary: "Determines the best physical path for data to reach its destination.",
                deep_dive: "This is where Logical Addressing (IP Addresses) happens. Routers operate here. They read the destination IP on the Packet and use routing tables (and protocols like BGP) to decide the most efficient path across the myriad networks of the internet."
            },
            { 
                id: 2, 
                name: "Data Link", 
                pdu: "Frame", 
                analogy: "The Local Truck", 
                protocols: "Ethernet, Wi-Fi (802.11), MAC, PPP, VLAN", 
                devices: "Switches, Bridges, WAPs, NICs", 
                summary: "Facilitates data transfer between two devices on the SAME network.",
                deep_dive: "This layer deals with Physical Addressing (MAC Addresses) burned into hardware. It encapsulates Packets into Frames. Switches operate here to forward frames to the correct device port. It also handles basic error detection on the physical line."
            },
            { 
                id: 1, 
                name: "Physical", 
                pdu: "Bit", 
                analogy: "The Road / The Wire", 
                protocols: "DSL, USB, Bluetooth, OTN, 100Base-T", 
                devices: "Cables (Cat6, Fiber), Hubs, Repeaters", 
                summary: "The raw hardware transmission of binary data (1s and 0s) over a medium.",
                deep_dive: "This is the tangible world. Voltages on a copper wire, pulses of light in a fiber optic cable, or radio waves in Wi-Fi. It doesn't care what the data is; its only job is to get a signal from Point A to Point B physically."
            }
        ];

        // --- PROTOCOL DATA ---
        const protocolData = {
            'application': {
                name: "Application & Web",
                items: [
                    { id: 'http', name: 'HTTP', port: '80', transport: 'TCP', icon: 'globe', desc: 'HyperText Transfer Protocol. Foundation of data communication for the World Wide Web.', analogy: 'Sending a postcard. Anyone who picks it up can read it (unencrypted).' },
                    { id: 'https', name: 'HTTPS', port: '443', transport: 'TCP', icon: 'lock', desc: 'HTTP Secure. Uses SSL/TLS to encrypt packets.', analogy: 'Sending a letter in a locked, armored briefcase. Only the recipient has the key.' },
                    { id: 'ssh', name: 'SSH', port: '22', transport: 'TCP', icon: 'terminal', desc: 'Secure Shell. Cryptographic network protocol for operating network services securely over an unsecured network.', analogy: 'A secure, encrypted tunnel directly into the mainframe.' }
                ]
            },
            'infrastructure': {
                name: "Infrastructure",
                items: [
                    { id: 'dns', name: 'DNS', port: '53', transport: 'UDP/TCP', icon: 'search', desc: 'Domain Name System. Translates human readable domain names (www.google.com) to IP addresses.', analogy: 'The Phonebook of the Internet.' },
                    { id: 'dhcp', name: 'DHCP', port: '67/68', transport: 'UDP', icon: 'refresh-cw', desc: 'Dynamic Host Configuration Protocol. Dynamically assigns IP addresses to devices.', analogy: 'The ticket dispenser at a parking lot assigning spots automatically.' }
                ]
            },
            'physical': {
                name: "Physical Layer",
                items: [
                    { id: 'rj45', name: 'RJ45 (Copper)', port: 'N/A', transport: 'Ethernet', icon: 'plug', desc: 'Standard connector for twisted pair cabling (Cat5e, Cat6). Limited to 100m distance.', analogy: 'Standard telephone wire on steroids. Good for short hops inside a building.' },
                    { id: 'sfp', name: 'SFP/SFP+ (Fiber)', port: 'N/A', transport: 'Light', icon: 'zap', desc: 'Small Form-factor Pluggable. Uses fiber optics for high speed (10G+) and long distance transmission.', analogy: 'A laser beam data highway. Speed of light transmission with no electrical interference.' }
                ]
            }
        };

        // --- OSI MODAL FUNCTIONS ---
        function openOsiModal(layerId) {
            const layer = osiLayers.find(l => l.id === layerId);
            if (!layer) return;

            const contentDiv = document.getElementById('osi-detail-content');
            
            // Build the Modal Content dynamically
            contentDiv.innerHTML = `
                <!-- LEFT COLUMN: CORE INFO -->
                <div class="flex flex-col gap-6">
                    <div class="bg-black/60 border-l-4 border-cyan-500 p-6 rounded-r relative overflow-hidden">
                        <div class="absolute -right-4 -top-4 text-8xl text-cyan-500/10 font-cyber font-bold select-none">${layer.id}</div>
                        <h3 class="text-2xl font-bold text-white font-tech mb-1 uppercase">${layer.name} LAYER</h3>
                        <p class="text-slate-400 font-mono text-sm border-b border-slate-700 pb-4 mb-4">${layer.summary}</p>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-[10px] text-cyan-500 uppercase tracking-widest font-bold mb-1">DATA UNIT (PDU)</div>
                                <div class="text-xl text-white font-mono bg-cyan-900/20 px-2 py-1 rounded inline-block border border-cyan-500/30">${layer.pdu}</div>
                            </div>
                            <div>
                                <div class="text-[10px] text-yellow-500 uppercase tracking-widest font-bold mb-1">THE ANALOGY</div>
                                <div class="text-sm text-yellow-100 font-tech italic">"${layer.analogy}"</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-black/60 border border-slate-700 p-5 rounded">
                        <div class="text-[10px] text-slate-500 uppercase tracking-widest font-bold mb-3">HARDWARE & DEVICES</div>
                        <div class="flex flex-wrap gap-2">
                            ${layer.devices.split(',').map(d => `<span class="px-2 py-1 bg-slate-800 text-slate-300 text-xs rounded border border-slate-600">${d.trim()}</span>`).join('')}
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: DEEP DIVE -->
                <div class="flex flex-col gap-6">
                    <div class="bg-gradient-to-br from-purple-900/20 to-black border border-purple-500/30 p-6 rounded h-full">
                        <h4 class="text-lg font-bold text-purple-400 font-cyber mb-4 flex items-center gap-2">
                            <i data-lucide="cpu" size="20"></i> PROTOCOLS
                        </h4>
                        <div class="flex flex-wrap gap-2 mb-6">
                            ${layer.protocols.split(',').map(p => `<span class="px-3 py-1 bg-purple-900/40 text-purple-200 text-sm font-mono rounded-full border border-purple-500/40 shadow-[0_0_10px_rgba(168,85,247,0.1)]">${p.trim()}</span>`).join('')}
                        </div>

                        <h4 class="text-lg font-bold text-cyan-400 font-cyber mb-4 flex items-center gap-2">
                            <i data-lucide="microscope" size="20"></i> GRANULAR ANALYSIS
                        </h4>
                        <div class="text-sm text-slate-300 leading-7 font-mono text-justify">
                            ${layer.deep_dive}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('osi-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeOsiModal() {
            document.getElementById('osi-modal').classList.add('hidden');
        }

        // --- PROTOCOL MODAL FUNCTIONS ---
        function openProtocolModal(catId, itemId) {
            const item = protocolData[catId].items.find(i => i.id === itemId);
            if(!item) return;

            const contentDiv = document.getElementById('protocol-detail-content');
            
            contentDiv.innerHTML = `
                <div class="flex flex-col md:flex-row gap-8 h-full">
                    <div class="w-full md:w-1/2 flex flex-col gap-6">
                        <div class="bg-black/60 border-l-4 border-yellow-500 p-6 rounded-r relative">
                            <h3 class="text-4xl font-bold text-white font-cyber mb-2">${item.name}</h3>
                            <div class="flex items-center gap-4 text-sm font-mono">
                                <span class="bg-yellow-900/40 text-yellow-300 px-2 py-1 rounded border border-yellow-500/30">PORT: ${item.port}</span>
                                <span class="bg-slate-800 text-slate-300 px-2 py-1 rounded border border-slate-600">PROTO: ${item.transport}</span>
                            </div>
                        </div>
                        
                        <div class="bg-black/60 p-6 rounded border border-slate-800">
                            <h4 class="text-sm font-bold text-orange-400 font-cyber mb-3 uppercase">Technical Definition</h4>
                            <p class="text-slate-300 text-sm leading-relaxed">${item.desc}</p>
                        </div>
                    </div>

                    <div class="w-full md:w-1/2 bg-gradient-to-br from-orange-900/10 to-black border border-orange-500/30 p-6 rounded flex flex-col justify-center items-center text-center">
                        <div class="mb-6 p-6 rounded-full bg-orange-500/10 border border-orange-500/50 shadow-[0_0_30px_rgba(249,115,22,0.2)]">
                            <i data-lucide="${item.icon}" class="w-16 h-16 text-orange-400"></i>
                        </div>
                        <h4 class="text-lg font-bold text-white font-tech mb-2">SCENARIO ANALOGY</h4>
                        <div class="text-xl text-yellow-200 font-cyber italic leading-normal">
                            "${item.analogy}"
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('protocol-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeProtocolModal() {
            document.getElementById('protocol-modal').classList.add('hidden');
        }

        // --- KNOWLEDGE BASE (CORTEX) ---
        const knowledgeDb = {
            'as_number': {
                title: 'Guide: Initial BGP Setup',
                content: `...` // (Content truncated for brevity, same as previous)
            },
            // ... (Other knowledgeDb entries remain same)
        };

        // ... (Existing helper functions: showConcept, closeModal, scrambleText, etc. remain the same)
        
        // --- ANIMATION UTILS ---
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%&';
        function scrambleText(element, finalString) {
            let iterations = 0;
            const interval = setInterval(() => {
                element.innerText = finalString.split('').map((letter, index) => {
                    return index < iterations ? finalString[index] : chars[Math.floor(Math.random() * chars.length)];
                }).join('');
                if (iterations >= finalString.length) clearInterval(interval);
                iterations += 1 / 3;
            }, 30);
        }

        // --- WARP SPEED STARFIELD ANIMATION ---
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        const stars = [];
        const numStars = 400;
        const warpSpeed = 15;

        function resizeCanvas() {
            width = canvas.width = canvas.parentElement.offsetWidth;
            height = canvas.height = canvas.parentElement.offsetHeight;
        }

        class Star {
            constructor() { this.reset(); }
            reset() {
                this.x = (Math.random() - 0.5) * width;
                this.y = (Math.random() - 0.5) * height;
                this.z = Math.random() * width;
                this.pz = this.z;
            }
            update() {
                this.z = this.z - warpSpeed;
                if (this.z < 1) { this.reset(); this.z = width; this.pz = this.z; }
            }
            draw() {
                const cx = width / 2;
                const cy = height / 2;
                const sx = (this.x / this.z) * width + cx;
                const sy = (this.y / this.z) * height + cy;
                const px = (this.x / this.pz) * width + cx;
                const py = (this.y / this.pz) * height + cy;
                this.pz = this.z;
                const opacity = 1 - (this.z / width);
                ctx.beginPath();
                ctx.moveTo(px, py);
                ctx.lineTo(sx, sy);
                ctx.strokeStyle = `rgba(0, 240, 255, ${opacity})`;
                ctx.lineWidth = opacity * 2;
                ctx.stroke();
            }
        }

        function initStars() {
            for(let i=0; i<numStars; i++) stars.push(new Star());
        }

        function animateCanvas() {
            ctx.fillStyle = "rgba(0, 0, 0, 0.4)";
            ctx.fillRect(0, 0, width, height);
            for(let i=0; i<stars.length; i++) { stars[i].update(); stars[i].draw(); }
            requestAnimationFrame(animateCanvas);
        }

        // --- APP LOGIC (State & Subnets) ---
        // (Reusing existing logic logic completely)
        const possibleClasses = ['A', 'B', 'C'];
        const BGP_PEERING_RANGE_IP = '192.168.0.0';
        const BGP_PEERING_CIDR = 16;
        const initialIspA = { name: 'ISP A', block: '10.0.0.0', cidr: 8, as: 65001, color: 'green', keepalive: 60, holdtime: 180 };
        const initialIspB = { name: 'ISP B', block: '172.16.0.0', cidr: 12, as: 65002, color: 'blue', keepalive: 60, holdtime: 180 };

        let state = {
            score: 0,
            efficiency: 0,
            activeTab: 'A',
            ispA: { ...initialIspA, routerId: '', iBGPStatus: 'pending', localPref: 100, message: '' },
            ispB: { ...initialIspB, routerId: '', iBGPStatus: 'pending', localPref: 100, message: '' },
            peering: { ip: '', cidr: 30, remoteAs: initialIspB.as, status: 'pending', message: '', realData: null },
            zones: [],
            selectedZoneId: null,
            inputIp: '',
            inputCidr: 24,
            inputMask: '255.255.255.0'
        };

        function generateZones() {
            const zones = [];
            const positions = ['top-left', 'top-right', 'bottom-left', 'bottom-right'];
            for (let i = 1; i <= 30; i++) {
                const ispId = i <= 15 ? 'A' : 'B';
                zones.push({
                    id: i,
                    name: `Sector ${String(i).padStart(2, '0')}`,
                    hostsRequired: Math.floor(Math.random() * 241) + 10,
                    reqClass: possibleClasses[Math.floor(Math.random() * possibleClasses.length)],
                    ispId: ispId,
                    position: positions[i % 4],
                    status: 'offline', 
                    config: { ip: '', cidr: 24 },
                    houseIps: [],
                    message: "Awaiting Uplink"
                });
            }
            return zones;
        }
        state.zones = generateZones();
        state.selectedZoneId = state.zones[0].id;

        // --- IP Calculation Utilities ---
        const ipToLong = (ip) => {
            if(!ip) return null;
            const parts = ip.split('.');
            if (parts.length !== 4 || parts.some(p => isNaN(parseInt(p)))) return null;
            return ((parseInt(parts[0], 10) << 24) | (parseInt(parts[1], 10) << 16) | (parseInt(parts[2], 10) << 8) | parseInt(parts[3], 10)) >>> 0;
        };
        const longToIp = (long) => [(long >>> 24) & 0xFF, (long >>> 16) & 0xFF, (long >>> 8) & 0xFF, long & 0xFF].join('.');
        const cidrToMask = (cidr) => {
             const maskLong = ~((1 << (32 - cidr)) - 1);
             return longToIp(maskLong >>> 0);
        };
        const maskToCidr = (mask) => {
            const long = ipToLong(mask);
            if(long === null) return null;
            let cidr = 0;
            for(let i=31; i>=0; i--) {
                if((long & (1<<i)) !== 0) cidr++;
                else break;
            }
            return cidr;
        };
        const isIpInSubnet = (ipLong, networkLong, cidr) => {
            const mask = ~((1 << (32 - cidr)) - 1);
            return (ipLong & mask) === (networkLong & mask);
        };
        const calculateSubnet = (ip, cidr) => {
            const ipLong = ipToLong(ip);
            if (ipLong === null || cidr < 1 || cidr > 32) return null;
            const mask = ~((1 << (32 - cidr)) - 1);
            const networkLong = (ipLong & mask) >>> 0;
            const broadcastLong = (networkLong | ~mask) >>> 0;
            const usableStart = (networkLong + 1) >>> 0;
            const usableEnd = (broadcastLong - 1) >>> 0;
            const hosts = Math.max(0, usableEnd > usableStart ? usableEnd - usableStart + 1 : 0);
            const houseIps = [];
            for(let i=0; i<Math.min(hosts, 20); i++) houseIps.push(longToIp(usableStart + i));
            return { networkAddress: longToIp(networkLong), broadcastAddress: longToIp(broadcastLong), firstHost: longToIp(usableStart), lastHost: longToIp(usableEnd), totalHosts: hosts, houseIps };
        };
        const octetToBinary = (octet) => parseInt(octet, 10).toString(2).padStart(8, '0');
        const ipToBinary = (ip) => {
            const parts = ip.split('.');
            if (parts.length !== 4) return 'Invalid IP';
            return parts.map(octetToBinary).join('.');
        }

        // --- Helper Handlers ---
        function updateZoneMask(val) {
            state.inputMask = val;
            const cidr = maskToCidr(val);
            if(cidr) { state.inputCidr = cidr; renderContent(); }
        }
        function updateZoneCidr(val) {
            state.inputCidr = parseInt(val);
            state.inputMask = cidrToMask(state.inputCidr);
            renderContent();
        }
        function handleIpInput(val) {
            if(val.includes('/')) {
                const parts = val.split('/');
                if(parts.length === 2) {
                    const ip = parts[0].trim();
                    const cidr = parseInt(parts[1]);
                    if(cidr >= 8 && cidr <= 30) {
                        state.inputIp = ip; state.inputCidr = cidr; state.inputMask = cidrToMask(cidr); renderContent(); return;
                    }
                }
            } 
            state.inputIp = val;
            const parts = val.split('.');
            if(parts.length === 4 && parts.every(p => p.length > 0) && !state.ipAutoDetected) {
                const firstOctet = parseInt(parts[0]);
                let detectedCidr = 24;
                if(firstOctet >= 1 && firstOctet <= 126) detectedCidr = 8;
                else if(firstOctet >= 128 && firstOctet <= 191) detectedCidr = 16;
                state.inputCidr = detectedCidr;
                state.inputMask = cidrToMask(detectedCidr);
                state.ipAutoDetected = true;
                renderContent();
            } else if (parts.length < 4) { state.ipAutoDetected = false; }
        }
        function generateIOSConfig(ispKey) {
            const d = state[ispKey];
            return `router bgp ${d.as}
 bgp router-id ${d.routerId || '0.0.0.0'}
 bgp log-neighbor-changes
 timers bgp ${d.keepalive} ${d.holdtime}
 neighbor 192.168.0.2 remote-as ${ispKey === 'ispA' ? state.ispB.as : state.ispA.as}
 neighbor 192.168.0.2 description PEERING_LINK
 !
 address-family ipv4
  network ${d.block} mask ${cidrToMask(d.cidr)}
  neighbor 192.168.0.2 activate
  neighbor 192.168.0.2 route-map SET_LP_${d.localPref} out
 exit-address-family`;
        }
        function typeWriter(text, element, speed = 10) {
            let i = 0; element.classList.add('typing-cursor');
            function type() {
                if (i < text.length) { element.textContent += text.charAt(i); i++; setTimeout(type, speed); } else { element.classList.remove('typing-cursor'); }
            }
            type();
        }
        function addLog(source, message, type = 'info') {
            const logContainer = document.getElementById('console-log');
            const anchor = document.getElementById('typing-anchor');
            const entry = document.createElement('div');
            entry.className = `mb-1 ${type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-slate-400'}`;
            const timestamp = new Date().toLocaleTimeString('en-US', {hour12: false});
            logContainer.insertBefore(entry, anchor);
            typeWriter(`[${timestamp}] ${source} > ${message}`, entry, 5);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        function updateIspBlock(ispKey, value) {
            const parts = value.split('/');
            if (parts.length !== 2) { addLog(state[ispKey].name, "Format Error: Use IP/CIDR (e.g., 10.0.0.0/8)", "error"); render(); return; }
            const ip = parts[0].trim(); const cidr = parseInt(parts[1]);
            const subnet = calculateSubnet(ip, cidr);
            if (!subnet) { addLog(state[ispKey].name, "Invalid Network Block Structure", "error"); render(); return; }
            state[ispKey].block = ip; state[ispKey].cidr = cidr;
            addLog(state[ispKey].name, `Block updated: ${ip}/${cidr}`, "success"); render();
        }
        function handleConfigIBGP(ispKey) {
            const cfg = state[ispKey];
            const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
            if (!ipRegex.test(cfg.routerId)) {
                cfg.iBGPStatus = 'error'; cfg.message = "Diagnostic: Router ID must be a valid 32-bit IP address to uniquely identify the BGP node."; addLog(cfg.name, "ERR: Invalid Router ID", "error");
            } else if (!cfg.as || cfg.as < 1) {
                cfg.iBGPStatus = 'error'; cfg.message = "Diagnostic: AS Number is required for BGP Process initialization."; addLog(cfg.name, "ERR: Invalid AS", "error");
            } else {
                cfg.iBGPStatus = 'configured'; cfg.message = `Analysis: iBGP Mesh Stable. Local Preference set to ${cfg.localPref} to influence outbound paths.`; state.score += 5; addLog(cfg.name, `iBGP Mesh Online. Policy Active.`, "success");
            }
            render();
        }
        function handleConfigEBGP() {
            const p = state.peering;
            if (state.ispA.iBGPStatus !== 'configured' || state.ispB.iBGPStatus !== 'configured') {
                p.status = 'error'; p.message = "Diagnostic: Cannot establish External BGP (eBGP) until Internal BGP (iBGP) stability is confirmed."; addLog("eBGP", "ERR: Local AS iBGP Down", "error"); render(); return;
            }
            const subnet = calculateSubnet(p.ip, p.cidr);
            const parentBlock = ipToLong(BGP_PEERING_RANGE_IP);
            if (!subnet || p.cidr !== 30 || !isIpInSubnet(ipToLong(p.ip), parentBlock, BGP_PEERING_CIDR)) {
                p.status = 'error'; p.message = "Protocol Mismatch: Point-to-Point links strictly require a /30 subnet (2 usable hosts) to conserve Global IP space."; addLog("eBGP", "ERR: Invalid Subnet (Requires /30)", "error");
            } else if (parseInt(p.remoteAs) !== state.ispB.as) {
                p.status = 'error'; p.message = `Security Alert: Remote AS mismatch. Expected AS${state.ispB.as} but configuration specifies AS${p.remoteAs}.`; addLog("eBGP", "ERR: AS Mismatch", "error");
            } else {
                p.status = 'configured'; p.message = "Link Established. Route Tables Exchanged."; p.realData = subnet; state.score += 15; addLog("eBGP", "PEERING ESTABLISHED [OK]", "success");
            }
            render();
        }
        function handleZoneConnect() {
            const zone = state.zones.find(z => z.id === state.selectedZoneId);
            if (!zone) return;
            const ispData = zone.ispId === 'A' ? state.ispA : state.ispB;
            const inputIp = state.inputIp;
            const inputCidr = parseInt(state.inputCidr);
            if (state.peering.status !== 'configured') {
                zone.status = 'error'; zone.message = "Network Failure: Uplink to Global Routing Table is down."; addLog("ZONE", `Connection failed: Global BGP Down`, "error"); render(); return;
            }
            const sub = calculateSubnet(inputIp, inputCidr);
            if (!sub) { zone.status = 'error'; zone.message = "Syntax Error: Invalid IP/CIDR combination."; render(); return; }
            const ipL = ipToLong(inputIp); const ispL = ipToLong(ispData.block);
            if (!isIpInSubnet(ipL, ispL, ispData.cidr)) {
                zone.status = 'error'; zone.message = `Policy Violation: Advertised IP is outside of owned AS Block (${ispData.block}/${ispData.cidr}).`; addLog("ZONE", `Route Rejected: Outside AS Block`, "error"); render(); return;
            }
            if (sub.networkAddress !== inputIp) {
                zone.status = 'error'; zone.message = `Configuration Error: Entry is not a Network ID. Suggestion: ${sub.networkAddress}`; render(); return;
            }
            if (sub.totalHosts < zone.hostsRequired) {
                zone.status = 'error'; zone.message = `Capacity Warning: Subnet /${inputCidr} (${sub.totalHosts} hosts) cannot support required ${zone.hostsRequired} nodes.`; render(); return;
            }
            const waste = sub.totalHosts - zone.hostsRequired;
            const efficiency = Math.max(0, 100 - (waste / sub.totalHosts * 100));
            if (zone.status !== 'online') { state.score += Math.floor(efficiency); }
            zone.status = 'online'; zone.message = `Route Advertised. Efficiency: ${efficiency.toFixed(1)}%`; zone.houseIps = sub.houseIps; zone.config = { ip: inputIp, cidr: inputCidr };
            addLog("ZONE", `${zone.name} ONLINE. Eff: ${efficiency.toFixed(1)}%`, "success"); render();
        }

        // --- RENDERERS ---
        function switchTab(tab) {
            state.activeTab = tab;
            if (tab === 'zones' && state.selectedZoneId) {
                const z = state.zones.find(x => x.id === state.selectedZoneId);
                state.inputIp = z.config.ip;
                state.inputCidr = z.config.cidr || 24;
                state.inputMask = cidrToMask(state.inputCidr);
            }
            //selectedOsiLayer = null; // Removed so logic persists, but visual reset handled elsewhere if needed
            scrambleText(document.getElementById('main-header'), 'NetSim Pro');
            render();
        }

        function renderAdvisor() {
            const container = document.getElementById('advisor-container');
            const t = state.activeTab;
            let title = "", text = "", type = "info";
            if (t === 'A' || t === 'B') {
                const isp = t === 'A' ? state.ispA : state.ispB;
                if(isp.iBGPStatus === 'error') { title = "Configuration Alert"; text = isp.message; type = "error"; } 
                else { title = "AS Policy Protocol"; text = "Configure iBGP to synchronize routes internally. The Router ID is a Loopback IP ensuring stability. LOCAL_PREF allows you to dictate outbound traffic flow (higher = better)."; type = "info"; }
            } else if (t === 'eBGP') {
                if(state.peering.status === 'error') { title = "Peering Protocol Failure"; text = state.peering.message; type = "error"; } 
                else { title = "Inter-AS Link Specification"; text = "Establishing a physical link requires a subnet from the agreed range (192.168.0.0/16). Standard practice dictates a /30 to conserve address space."; type = "warning"; }
            } else if (t === 'zones') { title = "VLSM Allocation Strategy"; text = "Variable Length Subnet Masking (VLSM) allows efficient use of IP space. Select a subnet mask that accommodates the host requirement with minimal waste."; type = "success"; } 
            else if (t === 'academy') { title = "Cyber Academy"; text = "Accessing Neural Network Training Modules. Select a topic below to begin data ingestion."; type = "success"; } 
            else if (t === 'osi') { title = "OSI Model Stack"; text = "Interactive Holographic Visualization. Click any layer to access the Master Class Deep Dive."; type = "info"; } 
            else if (t === 'protocols') { title = "Protocol Database"; text = "Port Registry and Physical Layer specs. Click a category to drill down into specific services."; type = "info"; } 
            else if (t === 'ports') { title = "Global Port Registry"; text = "Database of standard TCP/UDP ports. Use search to filter or load external CSV for full dataset."; type = "info"; }
            else if (t === 'stp') { title = "Spanning Tree Protocol"; text = "Layer 2 Loop Prevention. Visualizing Root Bridge election and path costs. Configure to prevent broadcast storms."; type = "info"; }
            else { title = "Binary Matrix Decoder"; text = "Visualizing the subnet mask in binary helps understand where the Network portion ends and the Host portion begins."; }
            const borderColor = type === 'info' ? 'border-cyan-500' : type === 'warning' ? 'border-yellow-500' : type === 'error' ? 'border-red-500' : 'border-green-500';
            const icon = type === 'error' ? 'alert-triangle' : 'info';
            container.innerHTML = `
                <div class="glass-panel border-l-4 ${borderColor} p-3 text-sm fade-enter-active">
                    <div class="font-bold mb-1 flex items-center gap-2 text-white font-cyber"><i data-lucide="${icon}" size="14"></i> ${title}</div>
                    <div class="text-slate-300 text-xs">${text}</div>
                </div>
            `;
        }

        function renderContent() {
            const container = document.getElementById('content-area');
            const tab = state.activeTab;

            if (tab === 'A' || tab === 'B') {
                const ispKey = tab === 'A' ? 'ispA' : 'ispB';
                const data = state[ispKey];
                const isCfg = data.iBGPStatus === 'configured';
                container.innerHTML = `
                    <div class="space-y-4 fade-enter-active">
                        <div class="p-4 border border-slate-700/50 rounded-lg bg-black/40 flex justify-between items-center backdrop-blur-md">
                            <div><label class="block text-xs text-slate-400 mb-1 font-cyber">Autonomous System (AS) <button onclick="showConcept('as_number')" class="text-cyan-400 hover:text-white ml-1">[?]</button></label><input type="number" class="bg-transparent font-mono text-white text-lg w-32 focus:border-b focus:border-cyan-500 outline-none transition-colors" value="${data.as}" onchange="state['${ispKey}'].as = parseInt(this.value); render();"></div>
                            <div class="text-right"><div class="text-[10px] text-slate-500 font-mono">ASSIGNED BLOCK</div><input type="text" class="bg-transparent font-mono text-green-400 text-right w-40 focus:border-b focus:border-green-500 outline-none transition-colors" value="${data.block}/${data.cidr}" onchange="updateIspBlock('${ispKey}', this.value)"></div>
                        </div>
                        <div class="p-4 border ${isCfg ? 'border-green-500/50 shadow-[0_0_25px_rgba(34,197,94,0.1)]' : 'border-slate-700'} rounded-lg glass-panel relative overflow-hidden transition-all duration-300">
                             ${isCfg ? '<div class="absolute top-0 right-0 p-2"><i data-lucide="check-circle" class="text-green-500 neon-green"></i></div>' : ''}
                            <h3 class="font-bold text-sm mb-3 text-cyan-400 font-cyber tracking-wider">iBGP Configuration</h3>
                            <div class="grid grid-cols-2 gap-4 mb-3">
                                <div><label class="block text-xs text-slate-400 mb-1">Router ID</label><input id="inp-rid-${ispKey}" type="text" class="w-full cyber-input rounded-sm p-2 font-mono text-white outline-none" placeholder="e.g., 10.10.1.1" value="${data.routerId}" ${isCfg ? 'disabled' : ''} onchange="state['${ispKey}'].routerId = this.value"></div>
                                <div><label class="block text-xs text-slate-400 mb-1">Local Pref <button onclick="showConcept('local_pref')" class="text-cyan-400 hover:text-white ml-1">[?]</button></label><input id="inp-pref-${ispKey}" type="number" class="w-full cyber-input rounded-sm p-2 font-mono text-white outline-none" value="${data.localPref}" onchange="state['${ispKey}'].localPref = parseInt(this.value)"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-3">
                                <div><label class="block text-xs text-slate-400 mb-1">Keepalive (sec)</label><input type="number" class="w-full cyber-input rounded-sm p-2 font-mono text-white outline-none" value="${data.keepalive}" onchange="state['${ispKey}'].keepalive = parseInt(this.value)"></div>
                                <div><label class="block text-xs text-slate-400 mb-1">Hold Time (sec)</label><input type="number" class="w-full cyber-input rounded-sm p-2 font-mono text-white outline-none" value="${data.holdtime}" onchange="state['${ispKey}'].holdtime = parseInt(this.value)"></div>
                            </div>
                            <button onclick="handleConfigIBGP('${ispKey}')" class="w-full py-2 rounded-sm font-bold text-sm transition-all relative overflow-hidden group mb-4 ${isCfg ? 'bg-green-600 text-white cursor-default' : 'bg-cyan-700 hover:bg-cyan-600 text-white shadow-lg shadow-cyan-900/50 border border-cyan-500/30'}"><span class="relative z-10">${isCfg ? 'System Online' : 'Initialize Daemon'}</span></button>
                             <div class="bg-black/60 border border-slate-800 rounded p-2 font-mono text-[10px] text-slate-400 overflow-x-auto shadow-inner"><div class="text-cyan-600 mb-1 select-none font-bold"># LIVE ROUTE CONFIG</div><pre class="text-green-500/80">${generateIOSConfig(ispKey)}</pre></div>
                        </div>
                    </div>`;
            } else if (tab === 'eBGP') {
                const p = state.peering; const isCfg = p.status === 'configured';
                container.innerHTML = `
                    <div class="space-y-4 fade-enter-active">
                        <div class="p-4 border ${isCfg ? 'border-green-500' : 'border-yellow-500/50'} rounded-lg glass-panel relative">
                             <div class="absolute -top-3 left-4 bg-[#050510] px-2 text-xs font-bold text-yellow-500 border border-yellow-600 rounded font-cyber shadow-[0_0_10px_rgba(234,179,8,0.3)]">CORE LINK</div>
                             <div class="mt-2 mb-3"><label class="block text-xs text-slate-400 mb-1">Peering Network IP (/30 recommended) <button onclick="showConcept('ebgp_subnet')" class="text-cyan-400 hover:text-white ml-1">[?]</button></label><input type="text" class="w-full cyber-input rounded-sm p-2 font-mono text-white outline-none" placeholder="192.168.x.x" value="${p.ip}" ${isCfg ? 'disabled' : ''} onchange="state.peering.ip = this.value"></div>
                             <div class="mb-4"><label class="block text-xs text-slate-400 mb-1">Remote AS Number</label><input type="number" class="w-full cyber-input rounded-sm p-2 font-mono text-white outline-none" value="${p.remoteAs}" ${isCfg ? 'disabled' : ''} onchange="state.peering.remoteAs = this.value"></div>
                             <button onclick="handleConfigEBGP()" class="w-full py-2 rounded-sm font-bold text-sm transition-all relative overflow-hidden group ${isCfg ? 'bg-green-600 text-white' : 'bg-yellow-600 hover:bg-yellow-500 text-white shadow-lg shadow-yellow-900/50 border border-yellow-500/30'}"><span class="relative z-10">${isCfg ? 'Link Established' : 'Connect Peer'}</span></button>
                        </div>
                    </div>`;
            } else if (tab === 'zones') {
                const zList = state.zones.map(z => `<div onclick="state.selectedZoneId=${z.id}; state.inputIp='${z.config.ip}'; state.inputCidr=${z.config.cidr||24}; state.inputMask=cidrToMask(state.inputCidr); render();" class="cursor-pointer p-2 rounded mb-1 border flex justify-between items-center text-xs transition-all duration-200 ${state.selectedZoneId === z.id ? 'bg-cyan-900/40 border-cyan-500 shadow-[0_0_15px_rgba(6,182,212,0.2)] scale-[1.02]' : 'bg-slate-800/30 border-transparent hover:bg-slate-700/50'}"><span class="font-bold font-mono ${z.status === 'online' ? 'text-green-400 neon-green' : 'text-slate-300'}">${z.name}</span><span class="${z.ispId==='A'?'text-green-500':'text-blue-500'} font-mono font-bold text-[10px]">AS${z.ispId==='A'?state.ispA.as:state.ispB.as}</span></div>`).join('');
                const currZ = state.zones.find(z => z.id === state.selectedZoneId); const ispData = currZ.ispId === 'A' ? state.ispA : state.ispB; const totalHosts = Math.pow(2, 32 - state.inputCidr) - 2; const waste = Math.max(0, totalHosts - currZ.hostsRequired); const wastePercent = Math.min(100, (waste / totalHosts) * 100);
                container.innerHTML = `
                    <div class="flex flex-col sm:flex-row gap-4 h-[380px] fade-enter-active">
                        <div class="w-full sm:w-1/3 overflow-y-auto pr-2 custom-scrollbar border-b sm:border-b-0 sm:border-r border-slate-700 pb-2 sm:pb-0 h-1/3 sm:h-full">${zList}</div>
                        <div class="w-full sm:w-2/3 glass-panel rounded p-4 flex flex-col h-2/3 sm:h-full">
                            <div class="flex justify-between items-start mb-4 border-b border-white/5 pb-2"><div><h3 class="font-bold text-white flex items-center gap-2 font-cyber">${currZ.name}${currZ.status === 'online' ? '<i data-lucide="check" class="text-green-400" size="16"></i>' : ''}</h3><div class="text-xs text-slate-400">Req: <span class="text-white font-bold">${currZ.hostsRequired}</span> hosts <button onclick="showConcept('vlsm')" class="text-cyan-400 hover:text-white ml-1">[?]</button></div></div><div class="text-[10px] font-mono px-2 py-1 rounded bg-black/60 border border-slate-700 text-${ispData.color}-400 shadow-inner">Source: ${ispData.block}/${ispData.cidr}</div></div>
                            <div class="space-y-4 flex-1 overflow-y-auto custom-scrollbar">
                                <div><label class="block text-xs text-slate-400 mb-1">Network Address (Auto-detects /CIDR)</label><input type="text" class="w-full cyber-input rounded-sm p-2 font-mono text-white text-sm outline-none" value="${state.inputIp}" oninput="handleIpInput(this.value)"></div>
                                <div class="grid grid-cols-2 gap-4"><div><label class="block text-xs text-slate-400 mb-1">Subnet Mask</label><input type="text" class="w-full cyber-input rounded-sm p-2 font-mono text-white text-sm outline-none" value="${state.inputMask}" onchange="updateZoneMask(this.value)"></div><div><label class="block text-xs text-slate-400 mb-1 text-right">CIDR /${state.inputCidr}</label><input type="range" min="8" max="30" value="${state.inputCidr}" class="w-full accent-cyan-500" oninput="updateZoneCidr(this.value)"></div></div>
                                <div class="bg-black/40 p-2 rounded border border-slate-800"><label class="block text-xs text-slate-400 mb-1 flex justify-between"><span>Efficiency Analysis</span><span class="${wastePercent > 50 ? 'text-red-400' : 'text-green-400'}">Waste: ${wastePercent.toFixed(1)}%</span></label><div class="h-2 w-full bg-slate-900 rounded-sm mt-2 overflow-hidden flex border border-slate-700"><div class="bg-gradient-to-r from-green-600 to-green-400 h-full" style="width: ${100 - wastePercent}%"></div><div class="bg-red-500/30 h-full" style="width: ${wastePercent}%"></div></div><div class="flex justify-between text-[9px] text-slate-500 mt-1 font-mono"><span>Used: ${currZ.hostsRequired}</span><span>Total: ${totalHosts}</span></div></div>
                                <div class="mt-auto pt-2"><button onclick="handleZoneConnect()" class="w-full py-2 bg-gradient-to-r from-cyan-700 to-blue-700 hover:from-cyan-600 hover:to-blue-600 text-white rounded-sm font-bold text-sm shadow-lg shadow-cyan-900/40 border border-cyan-500/30 transition-all hover:scale-[1.02]">Advertise Route</button></div>
                            </div>
                        </div>
                    </div>`;
            } else if (tab === 'academy') {
                container.innerHTML = `
                    <div class="space-y-4 fade-enter-active h-full flex flex-col overflow-y-auto custom-scrollbar pr-2">
                        <div class="glass-panel p-4 rounded-sm border border-cyan-500/30">
                            <div class="flex justify-between items-center mb-3"><h3 class="font-bold text-white font-cyber flex items-center gap-2"><i data-lucide="globe" class="text-cyan-400" size="16"></i> IP Scope Architecture</h3><div class="text-[10px] font-mono text-cyan-400 border border-cyan-800 px-1 bg-cyan-900/20">MODULE_01</div></div>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="bg-black/60 p-3 rounded border border-slate-800 relative group overflow-hidden"><div class="absolute inset-0 bg-cyan-500/5 group-hover:bg-cyan-500/10 transition-colors"></div><div class="text-cyan-400 font-bold font-tech mb-1">PUBLIC (WAN)</div><p class="text-[10px] text-slate-400 mb-2 leading-relaxed">Globally unique. Like a physical home address. Necessary for internet communication.</p><div class="h-12 bg-slate-900/80 rounded border border-slate-700 relative overflow-hidden flex items-center justify-center"><div class="absolute w-full h-0.5 bg-slate-800"></div><div class="w-2 h-2 bg-cyan-400 rounded-full edu-particle shadow-[0_0_5px_cyan]"></div><i data-lucide="globe" class="absolute left-1 text-slate-600 w-4 h-4"></i><i data-lucide="server" class="absolute right-1 text-slate-600 w-4 h-4"></i></div></div>
                                <div class="bg-black/60 p-3 rounded border border-slate-800 relative group overflow-hidden"><div class="absolute inset-0 bg-purple-500/5 group-hover:bg-purple-500/10 transition-colors"></div><div class="text-purple-400 font-bold font-tech mb-1">PRIVATE (LAN)</div><p class="text-[10px] text-slate-400 mb-2 leading-relaxed">Locally unique. Like a room number. Cannot travel the internet without NAT.</p><div class="h-12 bg-slate-900/80 rounded border border-slate-700 relative overflow-hidden flex items-center justify-center"><div class="absolute inset-2 border border-dashed border-purple-500/30 rounded"></div><div class="w-2 h-2 bg-purple-400 rounded-full edu-contained shadow-[0_0_5px_purple]"></div></div></div>
                            </div>
                            <div class="bg-slate-900/80 p-2 rounded border-l-2 border-purple-500 text-[10px] font-mono text-slate-400"><span class="text-white font-bold block mb-1">RFC 1918 BLOCKS (SAFE ZONES):</span><div class="flex gap-2"><span class="bg-black px-1 rounded text-purple-300 border border-purple-900/50 hover:bg-purple-900/30 transition-colors cursor-help" title="Enterprise Scale">10.0.0.0/8</span><span class="bg-black px-1 rounded text-purple-300 border border-purple-900/50 hover:bg-purple-900/30 transition-colors cursor-help" title="Mid-size Networks">172.16.0.0/12</span><span class="bg-black px-1 rounded text-purple-300 border border-purple-900/50 hover:bg-purple-900/30 transition-colors cursor-help" title="Home/Small Office">192.168.0.0/16</span></div></div>
                        </div>
                        <div class="glass-panel p-4 rounded-sm border border-yellow-500/30">
                            <div class="flex justify-between items-center mb-3"><h3 class="font-bold text-white font-cyber flex items-center gap-2"><i data-lucide="zap" class="text-yellow-400" size="16"></i> Assignment Logic</h3><div class="text-[10px] font-mono text-yellow-400 border border-yellow-800 px-1 bg-yellow-900/20">MODULE_02</div></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-black/60 p-3 rounded border border-slate-800 relative group overflow-hidden"><div class="text-yellow-400 font-bold font-tech mb-1 flex items-center gap-2"><i data-lucide="refresh-cw" size="12"></i> DYNAMIC (DHCP)</div><p class="text-[10px] text-slate-400 mb-2">Temporary lease. Changes automatically. Good for clients (phones, laptops).</p><div class="text-center font-mono text-white text-xs bg-slate-900 p-1 rounded border border-slate-700 edu-dynamic-text shadow-inner h-6 flex items-center justify-center"></div></div>
                                <div class="bg-black/60 p-3 rounded border border-slate-800 relative group overflow-hidden"><div class="text-green-400 font-bold font-tech mb-1 flex items-center gap-2"><i data-lucide="lock" size="12"></i> STATIC</div><p class="text-[10px] text-slate-400 mb-2">Permanent assignment. Configured manually. Critical for Servers/Routers.</p><div class="text-center font-mono text-green-400 text-xs bg-slate-900 p-1 rounded border border-green-900/50 shadow-[0_0_10px_rgba(34,197,94,0.2)] h-6 flex items-center justify-center">10.20.1.5 <i data-lucide="lock" size="10" class="ml-1"></i></div></div>
                            </div>
                        </div>
                    </div>`;
            } else if (tab === 'osi') {
                const layerHtml = osiLayers.map(l => `<div class="osi-layer p-3 rounded-sm border-l-2 border-slate-700 bg-black/60 mb-2 relative overflow-hidden hover:border-cyan-500 transition-all duration-200" onclick="openOsiModal(${l.id})"><div class="flex justify-between items-center relative z-10"><span class="font-mono text-xs text-slate-500 w-8">L${l.id}</span><span class="font-bold text-sm text-slate-300 flex-1 font-tech">${l.name}</span><span class="text-[10px] font-mono text-cyan-500 border border-cyan-900/50 px-1 rounded">${l.pdu}</span></div></div>`).join('');
                container.innerHTML = `
                    <div class="flex gap-4 h-full fade-enter-active">
                        <div class="w-full flex flex-col justify-center relative px-8">
                            <div class="absolute left-1/2 top-0 bottom-0 w-px bg-slate-800 -translate-x-1/2 z-0"></div>
                            <div class="packet-flow-down"></div>
                            <div class="relative z-10 space-y-2">${layerHtml}</div>
                            <div class="text-center mt-6 text-[10px] text-slate-500 font-mono animate-pulse">CLICK A LAYER FOR DEEP DIVE ANALYSIS</div>
                        </div>
                    </div>`;
            } else if (tab === 'protocols') {
                const categories = Object.keys(protocolData).map(key => {
                    const cat = protocolData[key];
                    const items = cat.items.map(item => `
                        <div class="bg-black/40 border border-slate-800 p-3 rounded hover:border-orange-500 transition-colors cursor-pointer group flex justify-between items-center" onclick="openProtocolModal('${key}', '${item.id}')">
                            <div class="flex items-center gap-3">
                                <i data-lucide="${item.icon}" class="text-orange-400 w-4 h-4"></i>
                                <span class="font-bold text-sm text-slate-300 group-hover:text-white">${item.name}</span>
                            </div>
                            <span class="text-[10px] font-mono text-slate-500">${item.port}</span>
                        </div>
                    `).join('');
                    
                    return `
                        <div class="mb-6">
                            <h3 class="text-xs font-bold text-yellow-500 uppercase tracking-widest mb-3 border-b border-yellow-500/20 pb-1">${cat.name}</h3>
                            <div class="grid grid-cols-1 gap-2">${items}</div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = `
                    <div class="fade-enter-active h-full overflow-y-auto custom-scrollbar pr-2">
                        <div class="glass-panel p-6 rounded-sm border border-orange-500/30">
                            ${categories}
                        </div>
                    </div>
                `;
            } else if (tab === 'ports') {
                const portsList = loadedPorts.map(p => `
                    <div class="flex items-center justify-between p-2 border-b border-slate-800 hover:bg-green-900/10 hover:border-green-500/50 transition-colors group">
                        <div class="w-16 font-mono text-green-400 text-sm">${p.port}</div>
                        <div class="w-20 font-mono text-slate-400 text-xs">${p.protocol}</div>
                        <div class="flex-1 text-slate-300 text-xs truncate group-hover:text-white">${p.desc}</div>
                    </div>
                `).join('');

                container.innerHTML = `
                    <div class="fade-enter-active h-full flex flex-col">
                        <div class="glass-panel p-4 rounded-sm border border-green-500/30 flex-1 flex flex-col overflow-hidden">
                            <div class="flex justify-between items-center mb-4 border-b border-green-500/20 pb-2">
                                <h3 class="font-bold text-white font-cyber flex items-center gap-2"><i data-lucide="list" class="text-green-400" size="16"></i> GLOBAL PORT REGISTRY</h3>
                                <div>
                                    <label class="px-3 py-1.5 bg-green-900/30 border border-green-500/50 rounded-sm text-[10px] font-bold text-green-300 cursor-pointer hover:bg-green-800/50 transition-colors uppercase tracking-wider flex items-center gap-2">
                                        <i data-lucide="upload" size="10"></i> MOUNT EXTERNAL CSV
                                        <input type="file" accept=".csv" class="hidden" onchange="handleFileSelect(event)">
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between px-2 py-1 text-[10px] font-bold text-slate-500 uppercase tracking-widest border-b border-slate-800 mb-2">
                                <div class="w-16">Port</div>
                                <div class="w-20">Protocol</div>
                                <div class="flex-1">Service / Description</div>
                            </div>

                            <div class="flex-1 overflow-y-auto custom-scrollbar">
                                ${portsList}
                            </div>
                            
                            <div class="text-[9px] text-slate-600 font-mono pt-2 text-right">
                                RECORDS LOADED: ${loadedPorts.length}
                            </div>
                        </div>
                    </div>
                `;
            } else if (tab === 'stp') {
                container.innerHTML = `
                    <div class="space-y-4 fade-enter-active h-full flex flex-col overflow-y-auto custom-scrollbar pr-2">
                        <div class="glass-panel p-4 rounded-sm border border-indigo-500/30">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-white font-cyber flex items-center gap-2">
                                    <i data-lucide="git-branch" class="text-indigo-400" size="16"></i> Spanning Tree Protocol
                                </h3>
                                <div class="text-[10px] font-mono text-indigo-400 border border-indigo-800 px-1 bg-indigo-900/20">IEEE 802.1D / 802.1w</div>
                            </div>
                            
                            <!-- Analogy Card -->
                            <div class="bg-black/60 border-l-2 border-indigo-500 p-3 rounded mb-4">
                                <div class="text-[10px] text-indigo-300 font-bold uppercase mb-1">Concept Analogy: "The Group Project"</div>
                                <p class="text-xs text-slate-300 leading-relaxed font-mono italic">
                                    "Imagine a group project. To stop 5 people from shouting at once (loops/broadcast storms), you pick ONE leader (Root Bridge). Everyone talks ONLY to the leader or a designated messenger. STP blocks the noisy paths."
                                </p>
                            </div>
                            
                            <!-- Interactive/Visual Topology -->
                            <div class="bg-black/60 p-4 rounded border border-slate-800 relative h-48 flex justify-center items-center mb-4">
                                <svg class="absolute inset-0 w-full h-full pointer-events-none">
                                    <!-- Triangle Lines -->
                                    <line x1="50%" y1="20%" x2="25%" y2="70%" stroke="#22c55e" stroke-width="2" class="opacity-50" /> <!-- Root to SW-B -->
                                    <line x1="50%" y1="20%" x2="75%" y2="70%" stroke="#22c55e" stroke-width="2" class="opacity-50" /> <!-- Root to SW-C -->
                                    <line x1="25%" y1="70%" x2="75%" y2="70%" stroke="#ef4444" stroke-width="2" stroke-dasharray="5,5" class="opacity-80" /> <!-- Blocked Link -->
                                    
                                    <!-- Port Status Indicators -->
                                    <circle cx="48%" cy="25%" r="3" fill="#22c55e" /> <circle cx="52%" cy="25%" r="3" fill="#22c55e" /> <!-- Root Ports -->
                                    <circle cx="28%" cy="65%" r="3" fill="#22c55e" /> <!-- RP on SW-B -->
                                    <circle cx="72%" cy="65%" r="3" fill="#22c55e" /> <!-- RP on SW-C -->
                                    <circle cx="30%" cy="70%" r="3" fill="#22c55e" /> <!-- DP on SW-B -->
                                    <circle cx="70%" cy="70%" r="3" fill="#ef4444" /> <!-- BLOCK on SW-C -->
                                </svg>
                                
                                <!-- Switches -->
                                <div class="absolute top-[10%] left-[50%] -translate-x-1/2 flex flex-col items-center z-10">
                                    <div class="w-10 h-10 bg-slate-900 border-2 border-yellow-500 rounded shadow-[0_0_15px_rgba(234,179,8,0.4)] flex items-center justify-center">
                                        <i data-lucide="crown" class="text-yellow-500 w-5 h-5"></i>
                                    </div>
                                    <span class="text-[9px] text-yellow-500 font-mono mt-1 font-bold">ROOT BRIDGE</span>
                                </div>

                                <div class="absolute top-[70%] left-[25%] -translate-x-1/2 flex flex-col items-center z-10">
                                    <div class="w-10 h-10 bg-slate-900 border border-slate-600 rounded flex items-center justify-center">
                                        <i data-lucide="box" class="text-slate-400 w-5 h-5"></i>
                                    </div>
                                    <span class="text-[9px] text-slate-500 font-mono mt-1">SW-B</span>
                                </div>

                                <div class="absolute top-[70%] left-[75%] -translate-x-1/2 flex flex-col items-center z-10">
                                    <div class="w-10 h-10 bg-slate-900 border border-slate-600 rounded flex items-center justify-center">
                                        <i data-lucide="box" class="text-slate-400 w-5 h-5"></i>
                                    </div>
                                    <span class="text-[9px] text-slate-500 font-mono mt-1">SW-C</span>
                                </div>
                            </div>
                            
                            <!-- Security Features Grid -->
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="bg-slate-900/50 p-2 rounded border border-red-900/30">
                                    <div class="text-[10px] text-red-400 font-bold mb-1 flex items-center gap-1"><i data-lucide="shield-alert" size="10"></i> BPDU GUARD</div>
                                    <p class="text-[9px] text-slate-400">Disables an access port if a switch is plugged in. Prevents unauthorized expansion.</p>
                                </div>
                                <div class="bg-slate-900/50 p-2 rounded border border-yellow-900/30">
                                    <div class="text-[10px] text-yellow-400 font-bold mb-1 flex items-center gap-1"><i data-lucide="crown" size="10"></i> ROOT GUARD</div>
                                    <p class="text-[9px] text-slate-400">Protects the Root Bridge role. If a better BPDU arrives, port becomes inconsistent.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Configuration Section -->
                        <div class="glass-panel p-4 rounded-sm border border-blue-500/30">
                            <h3 class="font-bold text-white font-cyber mb-3 text-xs uppercase flex items-center gap-2">
                                <i data-lucide="terminal" size="14" class="text-blue-400"></i> Configuration (Cisco IOS)
                            </h3>
                            <div class="bg-black/80 border border-slate-700 p-3 rounded font-mono text-[10px] text-slate-300 overflow-x-auto shadow-inner">
                                <div class="mb-3">
                                    <span class="text-slate-500">! 1. Enable Rapid PVST+ (Faster convergence)</span><br>
                                    <span class="text-blue-400">Switch(config)#</span> spanning-tree mode rapid-pvst
                                </div>
                                <div class="mb-3">
                                    <span class="text-slate-500">! 2. Force this switch to be Root Bridge (Primary)</span><br>
                                    <span class="text-blue-400">Switch(config)#</span> spanning-tree vlan 1 root primary
                                </div>
                                <div class="mb-3">
                                    <span class="text-slate-500">! 3. Configure Access Ports (BPDU Guard & PortFast)</span><br>
                                    <span class="text-blue-400">Switch(config)#</span> interface range Gi0/1 - 24<br>
                                    <span class="text-blue-400">Switch(config-if-range)#</span> switchport mode access<br>
                                    <span class="text-blue-400">Switch(config-if-range)#</span> spanning-tree portfast<br>
                                    <span class="text-blue-400">Switch(config-if-range)#</span> spanning-tree bpduguard enable
                                </div>
                                <div>
                                    <span class="text-slate-500">! 4. Root Guard (On ports connecting to other switches)</span><br>
                                    <span class="text-blue-400">Switch(config)#</span> interface Gi0/25<br>
                                    <span class="text-blue-400">Switch(config-if)#</span> spanning-tree guard root
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (tab === 'calc') {
                container.innerHTML = `
                    <div class="glass-panel rounded p-4 border border-slate-700 fade-enter-active">
                        <h3 class="font-bold text-cyan-400 mb-4 flex gap-2 items-center font-cyber"><i data-lucide="calculator"></i> Binary Matrix</h3>
                        <div class="flex gap-2 mb-4">
                            <input id="calc-ip" type="text" placeholder="IP Address" class="cyber-input p-2 rounded-sm font-mono text-white flex-1 min-w-0 outline-none">
                            <input id="calc-cidr" type="number" placeholder="24" class="cyber-input p-2 rounded-sm font-mono text-white w-16 outline-none">
                            <button onclick="runCalc()" class="bg-cyan-700 text-white px-4 rounded-sm hover:bg-cyan-600 font-bold border border-cyan-500/50 transition-colors">Calc</button>
                        </div>
                        <div id="calc-results" class="text-xs font-mono space-y-2 text-slate-300">Enter values to decode binary stream.</div>
                    </div>`;
            }
        }

        // ... (Run logic, Map, Status, Render, Init - reused)
        function runCalc() { const ip = document.getElementById('calc-ip').value; const cidr = parseInt(document.getElementById('calc-cidr').value); const res = calculateSubnet(ip, cidr); const div = document.getElementById('calc-results'); if(!res) { div.innerHTML = "<span class='text-red-400 font-bold'>Invalid Data Stream</span>"; return; } const binIp = ipToBinary(ip); const binMask = ipToBinary(longToIp(~((1 << (32 - cidr)) - 1) >>> 0)); div.innerHTML = `<div class="grid grid-cols-2 gap-2"><div class="bg-slate-900/80 p-2 rounded border border-slate-700">Network: <span class="text-green-400 neon-green">${res.networkAddress}</span></div><div class="bg-slate-900/80 p-2 rounded border border-slate-700">Broadcast: <span class="text-yellow-400">${res.broadcastAddress}</span></div><div class="col-span-2 bg-black/60 p-2 rounded border border-dashed border-slate-700"><div class="text-slate-500">IP Binary:</div><div class="break-all text-cyan-200 font-bold tracking-widest">${binIp}</div><div class="text-slate-500 mt-1">Mask Binary:</div><div class="text-yellow-500 break-all tracking-widest">${binMask}</div></div><div class="col-span-2 text-center text-cyan-400 pt-2 font-bold">Total Usable Hosts: ${res.totalHosts}</div></div>`; }
        function renderMap() { const svg = document.getElementById('network-map'); const nodesDiv = document.getElementById('map-nodes'); const width = svg.clientWidth || 800; const height = svg.clientHeight || 600; let svgContent = `<defs><filter id="glow" x="-20%" y="-20%" width="140%" height="140%"><feGaussianBlur stdDeviation="3" result="blur" /><feComposite in="SourceGraphic" in2="blur" operator="over" /></filter></defs>`; let nodesHtml = ''; const ispAPos = { x: 35, y: 50 }; const ispBPos = { x: 65, y: 50 }; const drawISPNode = (pos, data, key) => { const isActive = data.iBGPStatus === 'configured'; if(isActive) { svgContent += `<circle cx="${pos.x}%" cy="${pos.y}%" r="35" stroke="${key==='ispA'?'#22c55e':'#3b82f6'}" stroke-width="2" fill="none" opacity="0.4" filter="url(#glow)"><animate attributeName="r" values="35;48;35" dur="3s" repeatCount="indefinite" /><animate attributeName="opacity" values="0.4;0;0.4" dur="3s" repeatCount="indefinite" /></circle>`; } nodesHtml += `<div style="left: ${pos.x}%; top: ${pos.y}%; transform: translate(-50%, -50%);" class="absolute flex flex-col items-center pointer-events-auto cursor-pointer group" onclick="switchTab('${key==='ispA'?'A':'B'}')"><div class="w-14 h-14 md:w-16 md:h-16 rounded-full border-2 ${isActive ? (key==='ispA'?'border-green-500 shadow-[0_0_30px_rgba(34,197,94,0.5)] bg-green-900/20':'border-blue-500 shadow-[0_0_30px_rgba(59,130,246,0.5)] bg-blue-900/20') : 'border-slate-600 bg-black'} flex items-center justify-center z-10 transition-all duration-500 group-hover:scale-110 relative overflow-hidden backdrop-blur-sm"><div class="absolute inset-0 bg-white/10 opacity-0 group-hover:opacity-100 transition-opacity"></div><i data-lucide="server" class="${isActive ? (key==='ispA'?'text-green-400':'text-blue-400') : 'text-slate-500'} w-6 h-6"></i></div><div class="mt-3 bg-black/80 backdrop-blur px-2 py-1 rounded border border-slate-700 text-[10px] font-bold text-slate-300 font-mono shadow-lg tracking-wider">AS ${data.as}</div></div>`; }; drawISPNode(ispAPos, state.ispA, 'ispA'); drawISPNode(ispBPos, state.ispB, 'ispB'); if (state.peering.status === 'configured') { const x1 = ispAPos.x * (width/100); const y1 = ispAPos.y * (height/100); const x2 = ispBPos.x * (width/100); const y2 = ispBPos.y * (height/100); const offset = 30; const pathD = `M ${x1 + offset} ${y1} L ${x2 - offset} ${y2}`; svgContent += `<path d="${pathD}" stroke="#eab308" stroke-width="3" fill="none" class="draw-path" filter="url(#glow)" opacity="0.9"/><path d="${pathD}" stroke="#fff" stroke-width="1" fill="none" stroke-dasharray="10,20" class="animate-dash-slow" opacity="0.8" />`; } const slots = [{x: 15, y: 20}, {x: 85, y: 20}, {x: 15, y: 80}, {x: 85, y: 80}]; state.zones.slice(0, 4).forEach((zone, idx) => { const slot = slots[idx]; const targetISP = zone.ispId === 'A' ? ispAPos : ispBPos; const isOnline = zone.status === 'online'; const isSelected = zone.id === state.selectedZoneId; const color = zone.ispId === 'A' ? '#22c55e' : '#3b82f6'; const x1 = slot.x * (width/100); const y1 = slot.y * (height/100); const x2 = targetISP.x * (width/100); const y2 = targetISP.y * (height/100); const pathD = `M ${x1} ${y1} Q ${(x1+x2)/2} ${y1} ${x2} ${y2}`; svgContent += `<path d="${pathD}" stroke="#1e293b" stroke-width="2" fill="none" opacity="0.3" />`; if (isOnline) { svgContent += `<path d="${pathD}" stroke="${color}" stroke-width="2" fill="none" class="draw-path" filter="url(#glow)" />`; svgContent += `<circle r="2" fill="#fff"><animateMotion dur="${zone.ispId === 'A' && state.ispA.localPref > 100 ? '0.5s' : '1.5s'}" repeatCount="indefinite" path="${pathD}" rotate="auto" /></circle>`; } if (isSelected && state.activeTab === 'zones') { const cx = slot.x * (width/100); const cy = slot.y * (height/100); svgContent += `<g transform="translate(${cx}, ${cy})"><circle r="30" stroke="#00f0ff" stroke-width="1" fill="none" stroke-dasharray="20 10" class="animate-spin-slow" opacity="0.8"/><path d="M-35,0 L-25,0 M35,0 L25,0 M0,-35 L0,-25 M0,35 L0,25" stroke="#00f0ff" stroke-width="2" /></g>`; } nodesHtml += `<div style="left: ${slot.x}%; top: ${slot.y}%; transform: translate(-50%, -50%);" class="absolute w-12 h-12 md:w-14 md:h-14 rounded-full bg-black border ${isOnline ? (zone.ispId==='A'?'border-green-500 shadow-[0_0_15px_rgba(34,197,94,0.4)]':'border-blue-500 shadow-[0_0_15px_rgba(59,130,246,0.4)]') : (isSelected ? 'border-cyan-400 shadow-[0_0_15px_rgba(0,240,255,0.3)]' : 'border-slate-800')} flex items-center justify-center z-20 pointer-events-auto cursor-pointer hover:scale-110 transition-transform" onclick="state.selectedZoneId=${zone.id}; state.inputIp='${zone.config.ip}'; state.inputCidr=${zone.config.cidr||24}; state.inputMask=cidrToMask(state.inputCidr); switchTab('zones');"><i data-lucide="home" class="w-5 h-5 ${isOnline ? 'text-white' : 'text-slate-500'}"></i><div class="absolute -bottom-6 text-[9px] w-24 text-center text-slate-400 font-mono bg-black/80 rounded px-1 border border-slate-800">${zone.name}</div></div>`; }); svg.innerHTML = svgContent; nodesDiv.innerHTML = nodesHtml; lucide.createIcons(); }
        function updateGlobalStatus() { const statusPanel = document.getElementById('status-panel'); const statusText = document.getElementById('status-text'); const statusLight = document.getElementById('status-light'); const prefA = document.getElementById('pref-a-display'); const prefB = document.getElementById('pref-b-display'); const isUp = state.peering.status === 'configured'; const statusString = isUp ? "ONLINE" : "OFFLINE"; if(statusText.dataset.current !== statusString) { statusText.dataset.current = statusString; if(isUp) { statusPanel.classList.remove('border-red-500'); statusPanel.classList.add('border-green-500', 'shadow-[0_0_20px_rgba(34,197,94,0.3)]'); statusLight.classList.remove('bg-red-500', 'shadow-[0_0_10px_red]'); statusLight.classList.add('bg-green-500', 'shadow-[0_0_10px_#22c55e]'); statusText.classList.remove('text-red-400'); statusText.classList.add('text-green-400', 'neon-green'); } else { statusPanel.classList.add('border-red-500'); statusPanel.classList.remove('border-green-500', 'shadow-[0_0_20px_rgba(34,197,94,0.3)]'); statusLight.classList.add('bg-red-500', 'shadow-[0_0_10px_red]'); statusLight.classList.remove('bg-green-500', 'shadow-[0_0_10px_#22c55e]'); statusText.classList.add('text-red-400'); statusText.classList.remove('text-green-400', 'neon-green'); } scrambleText(statusText, statusString); } prefA.innerText = state.ispA.localPref; prefB.innerText = state.ispB.localPref; document.getElementById('score-display').innerText = state.score + "%"; }
        function render() { document.querySelectorAll('.nav-tab').forEach(btn => { if(btn.id === `tab-${state.activeTab}`) { btn.classList.add('active'); } else { btn.classList.remove('active'); } }); renderAdvisor(); renderContent(); renderMap(); updateGlobalStatus(); lucide.createIcons(); }
        window.onload = () => { resizeCanvas(); initStars(); animateCanvas(); render(); window.addEventListener('resize', () => { resizeCanvas(); renderMap(); }); };
    </script>
</body>
</html>
